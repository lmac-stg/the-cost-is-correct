<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GUESS THE RIGHT PRICE</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Capriola&family=DM+Serif+Text:ital@0;1&family=Knewave&family=Lexend:wght@100..900&family=Monofett&family=Monoton&family=Trocchi&display=swap" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; background: url('background.png') repeat; }
    .game-container { display: flex; gap: 2rem; max-width: 1200px; margin: auto; align-items: flex-start; }
    .game { background: white; padding: 2rem; border-radius: 30px; flex: 1; box-shadow: 14px 14px .25px rgba(0,0,0,0.5); border: 3px solid #000000; }
    .score-sidebar { background: white; padding: 1.5rem; border-radius: 12px; width: 250px; box-shadow: 14px 14px 1px rgba(0,0,0,0.5); border: 3px solid #000000; }
    
            .score-sidebar h3 {
          margin-top: 0;
          margin-bottom: 1rem;
          color: #333;
        }

        .total-score-display {
          background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
          border: 2px solid #007acc;
          border-radius: 8px;
          padding: 1rem;
          margin-bottom: 1rem;
          text-align: center;
        }

        .round-score-display {
          background: #f9f9f9;
          border: 1px solid #ddd;
          border-radius: 6px;
          padding: 0.75rem;
          margin-bottom: 1rem;
          text-align: center;
        }

        .round-score-display.hidden {
          display: none;
        }

        .score-history {
          border-top: 1px solid #eee;
          padding-top: 1rem;
        }

        .round-history-item {
          font-size: 0.9rem;
          border-bottom: 1px solid #f0f0f0;
          padding-bottom: 0.25rem;
        }

        .round-history-item:last-child {
          border-bottom: none;
        }

        .guess-input-container {
          display: flex;
          gap: 0.75rem;
          align-items: center;
          justify-content: flex-start;
          margin: 1rem 0;
        }

        .guess-input-container.showcase-centered {
          justify-content: center;
          max-width: 400px;
          margin: 1rem auto;
        }

        .guess-input-container input {
          flex: 1;
          min-width: 200px;
        }

        .guess-input-container button {
          font-size: 0.8rem;
          font-weight: bold;
          font-family: 'Capriola', sans-serif;
          padding: 0.4rem 0.6rem;
          background: #dc3545;
          border: none;
          border-radius: 12px;
          color: white;
          transition: background-color 0.2s ease;
          height: fit-content;
        }

        .guess-input-container button:hover {
          background: #c82333;
        }

        .catalog-price-input {
          display: flex;
          gap: 0.5rem;
          align-items: center;
          justify-content: flex-start;
          border: 0px dashed #dc3545;
          background: rgb(245, 245, 245);
          padding: 0.6rem 0.8rem;
          border-radius: 12px;
          width: fit-content;
          height: 1.75rem;
          position: relative;
        }

        .catalog-price-input::before {
          content: "$";
          font-size: 1.5rem;
          font-weight: bold;
          font-family: 'Knewave', cursive;
          color: #2c3e50;
          margin-right: 0.1rem;
          line-height: 1;
        }

        .catalog-price-input input {
          font-size: 1.5rem;
          font-weight: bold;
          font-family: 'Knewave', cursive;
          color: #2c3e50;
          border: none;
          background: transparent;
          text-align: left;
          width: 30px;
          padding: 0;
          outline: none;
          line-height: 1;
          margin: 0;
        }

        .catalog-price-input input::placeholder {
          color: #7f8c8d;
          font-size: 1.5rem;
          font-weight: bold;
          font-family: 'Knewave', cursive;
        }
    .round-score-display { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #007acc; }
    .total-score-display { background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center; }
    .score-history { margin-top: 1rem; }
    .score-history-item { display: flex; justify-content: between; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
    .score-history-item:last-child { border-bottom: none; }
    input { padding: 0.5rem; font-size: 1rem; margin-top: 1rem; width: 150px; }
    button { padding: 0.5rem 1rem; font-size: 1rem; margin-top: 1rem; cursor: pointer; }
    .feedback { margin-top: 1rem; font-weight: bold; }
    .difference { margin-top: 0.5rem; font-size: 1.2rem; color: #666; }
    .guesses-remaining { margin-top: 0.5rem; color: #888; font-size: 0.9rem; }
    .round-header { background: #8d8d8d; color: rgb(255, 255, 255); padding: 0.75rem; margin: -2rem -2rem 1rem -2rem; border-radius: 27px 27px 0 0; }
    .round-header h2 { 
      font-family: "Lexend", sans-serif; 
      margin: 0.1rem 0; 
      font-size: 3.5rem; 
      color: #ffffff; 
      text-shadow: 4px 4px .25px rgba(0,0,0,0.8);
      font-weight: 700;
    }
    .game-subtitle { font-size: 0.9rem; margin: .5rem 5rem 1rem 5rem; color: #f0f0f0; font-weight: normal; line-height: 2; }
    .progress-container { margin: 1rem 0; display: flex; justify-content: center; }
    .progress-line { display: flex; align-items: center; gap: 1rem; }
    .progress-point { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; transition: all 0.3s ease; }
    .progress-point.completed { background: #28a745; color: white; }
    .progress-point.current { background: #ffffff; color: #000; transform: scale(1.2); border: 2px solid #000000; box-shadow: 0 0 0 0px rgba(255, 255, 255, 0.3); }
    .progress-point.upcoming { background: #2b2c2c; color: white; }
    .progress-connector { width: 60px; height: 4px; background: #dee2e6; border-radius: 2px; }
    .progress-connector.completed { background: #28a745; }
    .catalog-layout { display: flex; align-items: flex-start; gap: 2rem; margin: 2rem 0; width: fit-content; min-width: 600px; max-width: 100%; }
    .catalog-image { flex: 0 0 auto; }
    .catalog-image img { width: auto; height: 350px; max-width: none; object-fit: contain; border-radius: 8px; box-shadow: 3px 3px 8px rgba(0,0,0,0.25); }
    .catalog-details { flex: 1; text-align: left; padding: 1rem 0; min-height: 350px; min-width: 300px; }
    .product-title-container { margin-bottom: 0.5rem; }
    .catalog-details h3 { margin-top: 0; margin-bottom: 0.1rem; font-size: 2rem; color: #333; font-family: 'Capriola', sans-serif; font-weight: bold; }
    .catalog-details h4 { margin-top: 0; margin-bottom: 0.3rem; font-size: 1.5rem; color: #555; font-family: 'Capriola', sans-serif; font-weight: normal; }
    #showcaseTitle { margin-top: 0; margin-bottom: 0.3rem; font-size: 2rem; color: #333; font-family: 'Capriola', sans-serif; }
    .catalog-details p { margin: 1rem 0 1.5rem 0; line-height: 1.5; color: #555; }
    .showcase-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .showcase-item { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; }
    .showcase-item img { width: 100%; max-width: 120px; border-radius: 4px; }
    .showcase-gallery { display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0; }
    .showcase-navigation { display: flex; align-items: center; justify-content: center; gap: 2rem; margin: 1rem 0; }
    .gallery-content { display: flex; align-items: flex-start; gap: 2rem; max-width: 600px; }
    .gallery-image { width: auto; height: 200px; max-width: 300px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .gallery-info { text-align: left; flex: 1; padding: 1rem 0; }
    .gallery-info h4 { margin-top: 0; font-size: 1.2rem; color: #000000; }
    .gallery-info p { margin: 0.5rem 0; line-height: 1.4; color: #555; }
    .gallery-nav { background: #007acc; color: white; border: none; padding: 0.5rem 1rem; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
    .gallery-nav:hover { background: #005a99; }
    .gallery-nav:disabled { background: #ccc; cursor: not-allowed; }
    .gallery-counter { font-size: 0.9rem; color: #666; font-weight: bold; }
    .store-info { display: flex; align-items: center; justify-content: flex-start; gap: 0.5rem; margin: 0.2rem 0; }
    .store-logo { height: 24px; width: auto; max-width: 80px; object-fit: contain; }
    .store-name { font-size: 0.9rem; color: #666; }
    #itemDescription, #galleryDescription { font-family: "DM Serif Text", serif; font-style: italic; max-height: 120px; overflow: hidden; transition: max-height 0.3s ease; cursor: pointer; position: relative; }
    #itemDescription:hover, #galleryDescription:hover { max-height: none; overflow: auto; }
    #itemDescription::after, #galleryDescription::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 20px; background: linear-gradient(transparent, rgba(255,255,255,0.9)); pointer-events: none; }
    #itemDescription:hover::after, #galleryDescription:hover::after { display: none; }
    .score-text { font-weight: bold; font-size: 1.1rem; }
    .score-excellent { color: #006400; } /* Dark green for 900-1000+ */
    .score-great { color: #228b22; } /* Green for 800-899 */
    .score-good { color: #32cd32; } /* Lime green for 700-799 */
    .score-okay { color: #ffa500; } /* Orange for 500-699 */
    .score-poor { color: #ff4500; } /* Red orange for 300-499 */
    .score-bad { color: #dc143c; } /* Crimson for 100-299 */
    .score-terrible { color: #8b0000; } /* Dark red for 0-99 */
    
    .game-complete-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem auto;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .game-complete-container h3 {
      margin-top: 0;
      color: #28a745;
      font-size: 1.8rem;
    }
    
    .preview-navigation {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      display: none;
      text-align: center;
    }
    .preview-navigation.active {
      display: block;
    }
    .preview-nav-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .preview-nav-btn {
      background: #007acc;
      color: white;
      border: none;
      padding: 0.3rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-block;
    }
    .preview-nav-btn:hover {
      background: #005a99;
    }
    .preview-nav-btn.current {
      background: #28a745;
    }
    
    .final-score {
      font-size: 1.3rem;
      color: #495057;
      margin: 1rem 0;
    }
    .final-grade {
      font-size: 1.5rem;
      color: #007acc;
      margin: 1rem 0;
      font-weight: bold;
    }
    .comeback-message {
      color: #6c757d;
      font-style: italic;
      margin-top: 1.5rem;
    }
    
    .image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
    .modal-content { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; }
    .modal-image { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
    .close-modal:hover { color: #ccc; }
    .clickable-image { cursor: pointer; transition: opacity 0.2s ease; }
    .clickable-image:hover { opacity: 0.9; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game">
      <div class="round-header">
        <h2>GUESS THE RIGHT PRICE</h2>
        <p class="game-subtitle">You get 2 chances to guess the retail price of items, receiving points based on how close you end up to the actual retail value. 3 rounds of single items followed by a Showcase. Don't bust or you'll get nothing!</p>
        <div class="progress-container">
          <div class="progress-line">
            <div class="progress-point current" id="point1">1</div>
            <div class="progress-connector" id="connector1"></div>
            <div class="progress-point upcoming" id="point2">2</div>
            <div class="progress-connector" id="connector2"></div>
            <div class="progress-point upcoming" id="point3">3</div>
            <div class="progress-connector" id="connector3"></div>
            <div class="progress-point upcoming" id="point4">🏆</div>
          </div>
        </div>
        
        <!-- Preview Navigation (hidden by default) -->
        <div class="preview-navigation" id="previewNavigation">
          <div style="font-weight: bold; margin-bottom: 0.5rem;">📅 Preview Mode</div>
          <div class="preview-nav-buttons">
            <a href="?" class="preview-nav-btn">Today</a>
            <a href="?preview=1" class="preview-nav-btn">Tomorrow</a>
            <a href="?preview=2" class="preview-nav-btn">+2 Days</a>
            <a href="?preview=3" class="preview-nav-btn">+3 Days</a>
            <a href="?preview=7" class="preview-nav-btn">+1 Week</a>
            <a href="?preview=30" class="preview-nav-btn">+1 Month</a>
            <a href="?preview=-1" class="preview-nav-btn">Yesterday</a>
          </div>
        </div>
      </div>

    <!-- Single Item Display -->
    <div id="singleItemView">
      <div class="catalog-layout">
        <div class="catalog-image">
          <img id="itemImage" class="clickable-image" src="" alt="Item" onclick="openImageModal(this.src)">
        </div>
        <div class="catalog-details">
          <div class="product-title-container">
            <h3 id="itemBrand">Loading...</h3>
            <h4 id="itemTitle">Loading...</h4>
          </div>
          <div class="store-info">
            <img id="storeLogoSingle" class="store-logo" src="" alt="Store">
            <span id="storeNameSingle" class="store-name">Store</span>
          </div>
          <div class="guess-input-container">
            <div class="catalog-price-input">
              <input type="number" id="guessInput" placeholder="0.00" />
            </div>
            <button onclick="makeGuess()" id="guessButton">Submit</button>
          </div>
          <p id="itemDescription">Loading item...</p>
        </div>
      </div>
    </div>

    <!-- Showcase Display -->
    <div id="showcaseView" class="hidden">
      <h3 id="showcaseTitle">Showcase Showdown</h3>
      
      <div class="showcase-navigation">
        <button class="gallery-nav" id="prevBtn" onclick="navigateGallery(-1)">‹</button>
        <div class="gallery-counter">
          <span id="galleryCounter">1 of 3</span>
        </div>
        <button class="gallery-nav" id="nextBtn" onclick="navigateGallery(1)">›</button>
      </div>
      
      <div class="catalog-layout">
        <div class="catalog-image">
          <img id="galleryImage" class="clickable-image" src="" alt="Showcase Item" onclick="openImageModal(this.src)">
        </div>
        <div class="catalog-details">
          <div class="product-title-container">
            <h3 id="galleryBrand">Item Brand</h3>
            <h4 id="galleryTitle">Item Title</h4>
          </div>
          <div class="store-info">
            <img id="galleryStoreLogo" class="store-logo" src="" alt="Store">
            <span id="galleryStoreName" class="store-name">Store</span>
          </div>
          <p id="galleryDescription">Item description</p>
        </div>
      </div>
      
      <p><strong>Guess the total price of all items!</strong></p>
      <div class="guess-input-container showcase-centered">
        <div class="catalog-price-input">
          <input type="number" id="guessInputShowcase" placeholder="0.00" />
        </div>
        <button onclick="makeGuess()" id="guessButtonShowcase">Submit</button>
      </div>
    </div>

    <div class="feedback" id="feedback"></div>
    <div class="guesses-remaining" id="guessesRemaining">Guesses remaining: 3</div>
    <div id="result"></div>
    </div>

    <!-- Score Sidebar -->
    <div class="score-sidebar">
      <h3>📊 Score Tracker</h3>
      <div class="total-score-display">
        <div><strong>Total Score</strong></div>
        <div id="sidebarTotalScore" style="font-size: 1.5rem; color: #007acc; font-weight: bold;">0</div>
        <div style="font-size: 0.9rem; color: #666;">out of 5,000 points</div>
      </div>
      
      <div class="round-score-display hidden" id="currentRoundScore">
        <div><strong>Round <span id="currentRoundNumber">1</span> Result</strong></div>
        <div id="roundScoreValue" class="score-text" style="font-size: 1.3rem; margin: 0.5rem 0;">0 points</div>
        <div id="roundScoreDetails" style="font-size: 0.9rem; color: #666;"></div>
      </div>
      
      <div class="score-history">
        <div style="font-weight: bold; margin-bottom: 0.5rem;">Round History</div>
        <div id="scoreHistoryList"></div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <div class="modal-content">
      <img id="modalImage" class="modal-image" src="" alt="Full Size Image">
    </div>
  </div>

  <script>
    let gameData = {};
    let currentRound = 1;
    let maxRounds = 4; // 3 single items + 1 showcase
    let currentItem = null;
    let currentShowcase = null;
    let currentGalleryIndex = 0; // Track which item in showcase is being viewed
    let guesses = [];
    let maxGuesses = 2;
    let gameOver = false;
    let totalScore = 0;
    let roundScores = [];
    let roundHistory = [];

    // Load items and set up daily challenge
    async function loadItems() {
      try {
        // Add cache-busting parameter to ensure fresh data
        const cacheBuster = new Date().getTime();
        const response = await fetch(`items.json?v=${cacheBuster}`);
        gameData = await response.json();
        
        // Debug: Check what we actually loaded
        console.log('Loaded gameData:', gameData);
        console.log('First single item from JSON:', gameData.single_items[0]);
        console.log('First item keys:', Object.keys(gameData.single_items[0]));
        
        // Auto-calculate showcase total prices from individual item prices
        if (gameData.showcases) {
          gameData.showcases.forEach(showcase => {
            if (showcase.items && showcase.items.length > 0) {
              showcase.total_price = showcase.items.reduce((total, item) => {
                return total + (item.price || 0);
              }, 0);
            }
          });
        }
        
        setupDailyChallenge();
      } catch (error) {
        console.error('Could not load items:', error);
        // Fallback data
        gameData = {
          single_items: [{
            id: 1,
            title: "Microwave Oven",
            description: "Standard countertop microwave, 1000W",
            price: 120,
            image: "https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?w=400&h=300&fit=crop"
          }],
          showcases: [{
            id: 1,
            title: "Kitchen Bundle",
            items: [{ title: "Toaster", price: 50, image: "", description: "2-slice toaster" }],
            total_price: 50
          }]
        };
        setupDailyChallenge();
      }
    }

    // Use today's date to pick items for the day
    function setupDailyChallenge() {
      // Check for preview mode
      const urlParams = new URLSearchParams(window.location.search);
      const previewDays = parseInt(urlParams.get('preview')) || 0;
      
      const today = new Date();
      const targetDate = new Date(today.getTime() + (previewDays * 24 * 60 * 60 * 1000));
      const dayOfYear = Math.floor((targetDate - new Date(targetDate.getFullYear(), 0, 0)) / 86400000);
      
      // Add preview indicator if in preview mode
      if (previewDays !== 0) {
        const previewDate = targetDate.toLocaleDateString();
        const previewText = previewDays > 0 ? `${previewDays} days in the future` : `${Math.abs(previewDays)} days in the past`;
        document.querySelector('.game-subtitle').innerHTML = 
          `<span style="color: #ffcc00; font-weight: bold;">🔍 PREVIEW MODE: ${previewText} (${previewDate})</span><br>` + 
          document.querySelector('.game-subtitle').textContent;
      }
      
      // Filter out items without proper data (empty title/brand, no price, or no image)
      const validSingleItems = gameData.single_items.filter(item => 
        ((item.brand && item.brand.trim() !== '') || (item.title && item.title.trim() !== '')) && 
        item.price > 0 && 
        item.image && item.image.trim() !== ''
      );
      
      const validShowcases = gameData.showcases.filter(showcase => 
        showcase.title && showcase.title.trim() !== '' && 
        showcase.total_price > 0 &&
        showcase.items && showcase.items.length > 0
      );
      
      // Pick 3 single items and 1 showcase for today from valid items only
      // Use dayOfYear * 3 to ensure each day gets completely unique items
      const singleItemsToday = [];
      for (let i = 0; i < 3; i++) {
        const itemIndex = (dayOfYear * 3 + i) % validSingleItems.length;
        singleItemsToday.push(validSingleItems[itemIndex]);
      }
      const showcaseIndex = dayOfYear % validShowcases.length;
      const showcaseToday = validShowcases[showcaseIndex];
      
      gameData.todaysGame = {
        rounds: [...singleItemsToday, showcaseToday]
      };
      
      // Show preview navigation if URL has preview parameter or if it's in preview mode
      const currentPreview = parseInt(urlParams.get('preview')) || 0;
      const previewNav = document.getElementById('previewNavigation');
      
      if (urlParams.has('preview') || currentPreview !== 0) {
        previewNav.classList.add('active');
        
        // Highlight current preview option
        document.querySelectorAll('.preview-nav-btn').forEach(btn => {
          btn.classList.remove('current');
          const btnUrl = new URL(btn.href);
          const btnPreview = parseInt(btnUrl.searchParams.get('preview')) || 0;
          if (btnPreview === currentPreview) {
            btn.classList.add('current');
          }
        });
      }
      
      startRound();
    }

    // Calculate percentage-based score (more granular - out of 1000 points)
    function calculateScore(guess, actualPrice) {
      if (guess > actualPrice) return 0; // Bust = 0 points
      
      const percentageOff = Math.abs((guess - actualPrice) / actualPrice);
      
      if (percentageOff === 0) return 1000; // Perfect guess
      
      // Deduct 10 points per 0.1% off (so 1% off = -100 points)
      // percentageOff is a decimal (e.g., 0.05 = 5%), multiply by 1000 to get points deducted
      const pointsDeducted = Math.floor(percentageOff * 1000);
      const score = Math.max(0, 1000 - pointsDeducted);
      
      return score;
    }

    // Show formatted result message
    function showResultMessage(htmlContent) {
      // Create modal backdrop
      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
        align-items: center; z-index: 1000;
      `;
      
      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white; padding: 2rem; border-radius: 12px; 
        max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif; line-height: 1.6;
      `;
      
      // Determine button text based on game state
      let buttonText = 'Continue';
      if (currentRound < maxRounds) {
        buttonText = currentRound === 3 ? 'Start Showcase!' : 'Next Round';
      } else {
        buttonText = 'View Final Results';
      }
      
      const actionButton = document.createElement('button');
      actionButton.textContent = buttonText;
      actionButton.style.cssText = `
        background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; 
        border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; 
        margin-top: 1.5rem; transition: background 0.2s; display: block; width: 100%;
      `;
      
      // Add hover effect
      actionButton.addEventListener('mouseenter', () => {
        actionButton.style.background = '#b91c1c';
      });
      actionButton.addEventListener('mouseleave', () => {
        actionButton.style.background = '#dc2626';
      });
      
      modal.innerHTML = htmlContent;
      modal.appendChild(actionButton);
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      
      // Function to close modal and continue game
      const proceedToNext = () => {
        backdrop.remove();
        
        if (currentRound < maxRounds) {
          // Start next round
          currentRound++;
          startRound();
        } else {
          // Show final results
          showFinalResults();
        }
      };
      
      actionButton.addEventListener('click', proceedToNext);
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) proceedToNext();
      });
    }

    // Get CSS class based on score value
    function getScoreColorClass(score) {
      if (score >= 900) return 'score-excellent';
      if (score >= 800) return 'score-great';
      if (score >= 700) return 'score-good';
      if (score >= 500) return 'score-okay';
      if (score >= 300) return 'score-poor';
      if (score >= 100) return 'score-bad';
      return 'score-terrible';
    }

    // Start a new round
    function startRound() {
      if (currentRound > maxRounds) {
        showFinalResults();
        return;
      }
      
      guesses = [];
      gameOver = false;
      currentGalleryIndex = 0; // Reset gallery index for new round
      document.getElementById('guessInput').value = '';
      document.getElementById('guessInputShowcase').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('result').textContent = '';
      document.getElementById('guessesRemaining').textContent = 'Guesses remaining: 2';
      
      // Hide current round score display when starting new round
      document.getElementById('currentRoundScore').classList.add('hidden');
      
      const roundData = gameData.todaysGame.rounds[currentRound - 1];
      
      if (currentRound <= 3) {
        // Single item round
        currentItem = roundData;
        currentShowcase = null;
        setupSingleItemRound();
      } else {
        // Showcase round
        currentShowcase = roundData;
        currentItem = null;
        setupShowcaseRound();
      }
      
      updateRoundDisplay();
    }

    function setupSingleItemRound() {
      document.getElementById('singleItemView').classList.remove('hidden');
      document.getElementById('showcaseView').classList.add('hidden');
      
      document.getElementById('itemImage').src = currentItem.image;
      
      // Handle both old format (title only) and new format (brand + title)
      console.log('Current item:', currentItem); // Debug log
      console.log('Brand field value:', currentItem.brand); // Debug - exact brand value
      console.log('Title field value:', currentItem.title); // Debug - exact title value
      console.log('All item keys:', Object.keys(currentItem)); // Debug - all properties
      
      // Check if this item has the new format (both brand and title fields)
      const hasBrand = currentItem.brand && currentItem.brand.trim() !== '';
      const hasTitle = currentItem.title && currentItem.title.trim() !== '';
      
      console.log('Has brand:', hasBrand, 'Has title:', hasTitle); // Debug
      
      if (hasBrand && hasTitle) {
        // New format with separate brand and title
        console.log('Using new format - Brand:', currentItem.brand, 'Title:', currentItem.title); // Debug
        document.getElementById('itemBrand').textContent = currentItem.brand.trim();
        document.getElementById('itemTitle').textContent = currentItem.title.trim();
      } else if (hasTitle) {
        // Legacy format - title contains full product name, split it
        console.log('Using legacy format for:', currentItem.title); // Debug
        const fullTitle = currentItem.title.trim();
        const parts = fullTitle.split(' ');
        if (parts.length >= 2) {
          document.getElementById('itemBrand').textContent = parts[0];
          document.getElementById('itemTitle').textContent = parts.slice(1).join(' ');
        } else {
          document.getElementById('itemBrand').textContent = fullTitle;
          document.getElementById('itemTitle').textContent = '';
        }
      } else {
        // Fallback
        console.log('Using fallback - no valid data found');
        document.getElementById('itemBrand').textContent = 'Unknown Brand';
        document.getElementById('itemTitle').textContent = 'Unknown Item';
      }
      
      document.getElementById('itemDescription').textContent = currentItem.description;
      
      // Display store information
      if (currentItem.store) {
        // Handle both string store names and store objects
        let storeName, storeLogo;
        if (typeof currentItem.store === 'string') {
          // If store is a string, look up the logo from the stores mapping
          storeName = currentItem.store;
          storeLogo = gameData.stores[currentItem.store] || 'images/logos/placeholder.png';
        } else {
          // If store is an object, use its properties directly
          storeName = currentItem.store.name;
          storeLogo = currentItem.store.logo;
        }
        
        document.getElementById('storeLogoSingle').src = storeLogo;
        document.getElementById('storeNameSingle').textContent = storeName;
      }
    }

    function setupShowcaseRound() {
      document.getElementById('singleItemView').classList.add('hidden');
      document.getElementById('showcaseView').classList.remove('hidden');
      
      document.getElementById('showcaseTitle').textContent = currentShowcase.title;
      
      // Reset gallery to first item
      currentGalleryIndex = 0;
      updateGalleryDisplay();
    }

    // Navigate through showcase gallery
    function navigateGallery(direction) {
      const newIndex = currentGalleryIndex + direction;
      if (newIndex >= 0 && newIndex < currentShowcase.items.length) {
        currentGalleryIndex = newIndex;
        updateGalleryDisplay();
      }
    }

    // Update the gallery display with current item
    function updateGalleryDisplay() {
      const currentGalleryItem = currentShowcase.items[currentGalleryIndex];
      
      document.getElementById('galleryImage').src = currentGalleryItem.image;
      
      // Handle both old format (title only) and new format (brand + title)
      if (currentGalleryItem.brand && currentGalleryItem.brand.trim() !== '' && currentGalleryItem.title && currentGalleryItem.title.trim() !== '') {
        // New format with separate brand and title
        document.getElementById('galleryBrand').textContent = currentGalleryItem.brand.trim();
        document.getElementById('galleryTitle').textContent = currentGalleryItem.title.trim();
      } else if (currentGalleryItem.title && currentGalleryItem.title.trim() !== '') {
        // Legacy format - try to split title into brand and product
        const fullTitle = currentGalleryItem.title.trim();
        const parts = fullTitle.split(' ');
        if (parts.length >= 2) {
          document.getElementById('galleryBrand').textContent = parts[0];
          document.getElementById('galleryTitle').textContent = parts.slice(1).join(' ');
        } else {
          document.getElementById('galleryBrand').textContent = fullTitle;
          document.getElementById('galleryTitle').textContent = '';
        }
      } else {
        // Fallback
        document.getElementById('galleryBrand').textContent = 'Unknown Brand';
        document.getElementById('galleryTitle').textContent = 'Unknown Item';
      }
      
      document.getElementById('galleryDescription').textContent = currentGalleryItem.description;
      
      // Update store info for the current item
      if (currentGalleryItem.store) {
        // Handle both string store names and store objects
        let storeName, storeLogo;
        if (typeof currentGalleryItem.store === 'string') {
          // If store is a string, look up the logo from the stores mapping
          storeName = currentGalleryItem.store;
          storeLogo = gameData.stores[currentGalleryItem.store] || 'images/logos/placeholder.png';
        } else {
          // If store is an object, use its properties directly
          storeName = currentGalleryItem.store.name;
          storeLogo = currentGalleryItem.store.logo;
        }
        
        document.getElementById('galleryStoreLogo').src = storeLogo;
        document.getElementById('galleryStoreName').textContent = storeName;
      }
      
      // Update counter
      document.getElementById('galleryCounter').textContent = 
        `${currentGalleryIndex + 1} of ${currentShowcase.items.length}`;
      
      // Update navigation buttons
      document.getElementById('prevBtn').disabled = currentGalleryIndex === 0;
      document.getElementById('nextBtn').disabled = currentGalleryIndex === currentShowcase.items.length - 1;
    }

    function updateRoundDisplay() {
      const roundNumber = currentRound + 1;
      const roundTitle = roundNumber <= 3 ? `Round ${roundNumber}` : 'Showcase Showdown';
      document.getElementById('round-title').textContent = roundTitle;
      document.getElementById('progress-bar').style.width = `${(currentRound / 4) * 100}%`;
      document.getElementById('progress-text').textContent = `${currentRound}/4 Rounds Complete`;
      
      // Initialize/update sidebar
      updateSidebar();
    }

    function updateSidebar() {
      // Update total score
      document.getElementById('sidebarTotalScore').textContent = totalScore.toLocaleString();
      
      // Update score history
      const historyList = document.getElementById('scoreHistoryList');
      historyList.innerHTML = '';
      
      roundHistory.forEach((round, index) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'round-history-item';
        roundDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin: 0.25rem 0;">
            <span>Round ${index + 1}${index === 3 ? ' (Showcase)' : ''}</span>
            <span class="${round.scoreClass}" style="font-weight: bold;">${round.score} pts</span>
          </div>
        `;
        historyList.appendChild(roundDiv);
      });
    }

    function showCurrentRoundScore(score, details, scoreClass) {
      const currentRoundElement = document.getElementById('currentRoundScore');
      const roundNumberElement = document.getElementById('currentRoundNumber');
      const scoreValueElement = document.getElementById('roundScoreValue');
      const scoreDetailsElement = document.getElementById('roundScoreDetails');
      
      roundNumberElement.textContent = currentRound + 1;
      scoreValueElement.textContent = `${score.toLocaleString()} points`;
      scoreValueElement.className = `score-text ${scoreClass}`;
      scoreDetailsElement.textContent = details;
      
      currentRoundElement.classList.remove('hidden');
    }

    function updateRoundDisplay() {
      // Update progress indicator
      for (let i = 1; i <= 4; i++) {
        const point = document.getElementById(`point${i}`);
        const connector = document.getElementById(`connector${i}`);
        
        if (i < currentRound) {
          // Completed rounds
          point.className = 'progress-point completed';
          if (connector) connector.className = 'progress-connector completed';
        } else if (i === currentRound) {
          // Current round
          point.className = 'progress-point current';
          if (connector) connector.className = 'progress-connector';
        } else {
          // Upcoming rounds
          point.className = 'progress-point upcoming';
          if (connector) connector.className = 'progress-connector';
        }
      }
    }

    // Initialize the game when page loads
    window.onload = loadItems;

    function makeGuess() {
      if (gameOver) return;
      
      // Get the appropriate input field based on current round
      const isShowcase = currentRound === 4;
      const inputId = isShowcase ? 'guessInputShowcase' : 'guessInput';
      const input = document.getElementById(inputId);
      const guess = parseInt(input.value);
      if (isNaN(guess)) return;

      guesses.push(guess);
      
      const actualPrice = currentItem ? currentItem.price : currentShowcase.total_price;

      if (guess > actualPrice) {
        document.getElementById('feedback').textContent = `You guessed $${guess} — BUST! Over the price.`;
        document.getElementById('guessesRemaining').textContent = '';
        endRound(false, actualPrice);
        return;
      }

      // Check for exact match first
      if (guess === actualPrice) {
        document.getElementById('feedback').textContent = `Wow! You were right on the money!`;
        document.getElementById('guessesRemaining').textContent = '';
        endRound(true, actualPrice);
        return;
      }

      const remaining = maxGuesses - guesses.length;
      
      if (guesses.length < maxGuesses) {
        // Calculate how far off the guess is as a percentage
        const percentageOff = Math.abs(actualPrice - guess) / actualPrice;
        let underMessage = '';
        
        if (percentageOff >= 0.5) {
          underMessage = 'WAY FAR OFF';
        } else if (percentageOff >= 0.35) {
          underMessage = 'PRETTY FAR OFF';
        } else if (percentageOff >= 0.25) {
          underMessage = 'UNDER';
        } else if (percentageOff >= 0.15) {
          underMessage = 'A BIT UNDER';
        } else {
          underMessage = 'SLIGHTLY UNDER';
        }
        
        document.getElementById('feedback').textContent = `You guessed $${guess}. You are ${underMessage}. Try again!`;
        document.getElementById('guessesRemaining').textContent = `Guesses remaining: ${remaining}`;
      } else {
        document.getElementById('guessesRemaining').textContent = '';
        endRound(true, actualPrice);
      }
      input.value = '';
    }

    function endRound(finalRound, actualPrice) {
      gameOver = true;
      const lastGuess = guesses[guesses.length - 1];
      let roundScore = 0;

      if (!finalRound) {
        let resultText = `<strong>Actual retail price: $${actualPrice}.</strong><br>You busted out! 0 points this round.`;
        showResultMessage(resultText);
      } else {
        const diff = actualPrice - lastGuess;
        roundScore = calculateScore(lastGuess, actualPrice);
        
        // Double points for showcase round (round 4)
        if (currentRound === 4) {
          roundScore *= 2;
        }
        
        let resultText = `<strong>Actual retail price: $${actualPrice}.</strong><br>`;
        
        if (diff === 0) {
          resultText += `Wow! You were right on the money with that one! 🎉`;
        } else {
          const percentageOff = (diff / actualPrice * 100).toFixed(1);
          resultText += `You were ${percentageOff}% under.`;
        }
        
        // Add showcase bonus indicator
        if (currentRound === 4) {
          resultText += `<br><br>🎯 SHOWCASE DOUBLE POINTS! 🎯`;
        }
        
        // Add colored score
        const scoreClass = getScoreColorClass(roundScore);
        resultText += `<br><span class="score-text ${scoreClass}">Round Score: ${roundScore.toLocaleString()} points</span>`;
        
        // Show formatted result
        showResultMessage(resultText);
      }

      roundScores.push(roundScore);
      totalScore += roundScore;
      
      // Add round to history
      let scoreClass = 'score-zero';
      let details = '';
      if (!finalRound) {
        details = 'Busted (over price)';
      } else {
        const diff = actualPrice - lastGuess;
        const percentageOff = (diff / actualPrice * 100).toFixed(1);
        details = diff === 0 ? 'Perfect guess!' : `${percentageOff}% under`;
        scoreClass = getScoreColorClass(roundScore);
      }
      
      roundHistory.push({
        score: roundScore,
        scoreClass: scoreClass,
        details: details
      });
      
      // Update sidebar displays
      updateSidebar();
      showCurrentRoundScore(roundScore, details, scoreClass);
      
      document.getElementById('result').innerHTML = resultText.replace(/\n/g, '<br>');
      
      // Add colored score display
      if (finalRound && roundScore > 0) {
        const scoreElement = document.createElement('div');
        scoreElement.className = `score-text ${getScoreColorClass(roundScore)}`;
        scoreElement.textContent = `Round Score: ${roundScore.toLocaleString()} points`;
        document.getElementById('result').appendChild(scoreElement);
      }
      
      updateRoundDisplay();
    }

    // Image modal functions
    function openImageModal(imageSrc) {
      document.getElementById('modalImage').src = imageSrc;
      document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    // Close modal when clicking outside the image
    document.getElementById('imageModal').onclick = function(event) {
      if (event.target === this) {
        closeImageModal();
      }
    };

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeImageModal();
      }
    });

    function showFinalResults() {
      let grade = 'F';
      if (totalScore >= 4500) grade = 'A+';  // 90%+
      else if (totalScore >= 4000) grade = 'A';   // 80%+
      else if (totalScore >= 3500) grade = 'B+';  // 70%+
      else if (totalScore >= 3000) grade = 'B';   // 60%+
      else if (totalScore >= 2500) grade = 'C+';  // 50%+
      else if (totalScore >= 2000) grade = 'C';   // 40%+
      else if (totalScore >= 1500) grade = 'D';   // 30%+
      
      // Use modal popup for game completion
      const completionContent = `
        <div style="text-align: center;">
          <h3 style="color: #28a745; font-size: 1.8rem; margin-top: 0;">🎉 Game Complete!</h3>
          <p style="font-size: 1.3rem; color: #495057; margin: 1rem 0;"><strong>Final Score: ${totalScore.toLocaleString()} / 5,000 points</strong></p>
          <p style="font-size: 1.5rem; color: #007acc; margin: 1rem 0; font-weight: bold;">Grade: ${grade}</p>
          <p style="color: #6c757d; font-style: italic; margin-top: 1.5rem;">Come back tomorrow for a new challenge!</p>
        </div>
      `;
      
      // Create modal backdrop
      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
        align-items: center; z-index: 1000;
      `;
      
      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white; padding: 2rem; border-radius: 12px; 
        max-width: 500px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif; line-height: 1.6; border: 3px solid #28a745;
      `;
      
      modal.innerHTML = completionContent;
      
      // Add close button
      const closeButton = document.createElement('button');
      closeButton.textContent = 'Close';
      closeButton.style.cssText = `
        background: #28a745; color: white; border: none; padding: 0.8rem 1.5rem; 
        border-radius: 8px; cursor: pointer; font-size: 1rem; margin-top: 1rem;
      `;
      closeButton.onclick = () => document.body.removeChild(backdrop);
      
      modal.appendChild(closeButton);
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
    }
  </script>
</body>
</html>
