<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Name Your Price!</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Koh+Santepheap:wght@100;300;400;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Capriola&family=DM+Serif+Text:ital@0;1&family=Gabarito:wght@400..900&family=Knewave&family=Lexend:wght@100..900&family=Monofett&family=Monoton&family=Trocchi&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  
  <!-- Chart.js for score visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; background: url('background.png') repeat; }
    .game-container { display: flex; gap: 2rem; max-width: 1200px; margin: auto; align-items: flex-start; }
    .game { background: white; padding: 2rem; border-radius: 30px; flex: 1; box-shadow: 14px 14px .25px rgba(0,0,0,0.5); border: 3px solid #000000; }
    .score-sidebar { background: white; padding: 1.5rem; border-radius: 30px; width: 250px; box-shadow: 14px 14px 1px rgba(0,0,0,0.5); border: 3px solid #000000; }
    
    /* Game Instructions Box - inside score sidebar */
    .game-instructions { 
      background: #f8f9fa; 
      padding: 1rem; 
      border-radius: 8px; 
      margin-top: 1.5rem; 
      border: 1px solid #dee2e6;
      border-top: 3px solid #007acc;
    }
    .game-instructions h3 { margin-top: 0; margin-bottom: 0.75rem; color: #333; font-size: 1rem; }
    
    /* How to Play collapsible button */
    .how-to-play-btn {
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      padding: 0;
      margin: 0;
      text-align: left;
      width: 100%;
      white-space: nowrap;
    }
    .how-to-play-btn:hover {
      color: #007acc;
    }
    
    /* Contact Us button - similar to How to Play */
    .contact-us-btn {
      background: none;
      border: none;
      font-size: 1rem;
      font-weight: bold;
      color: #333;
      cursor: pointer;
      padding: 0;
      margin: 0;
      text-align: left;
      width: 100%;
      white-space: nowrap;
    }
    .contact-us-btn:hover {
      color: #007acc;
    }
    .how-to-play-content {
      margin-top: 0.75rem;
    }
    
            .score-sidebar h3 {
          margin-top: 0;
          margin-bottom: 1rem;
          color: #333;
        }

        .total-score-display {
          background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
          border: 2px solid #007acc;
          border-radius: 8px;
          padding: 1rem;
          margin-bottom: 1rem;
          text-align: center;
        }

        .round-score-display {
          background: #f9f9f9;
          border: 1px solid #ddd;
          border-radius: 6px;
          padding: 0.75rem;
          margin-bottom: 1rem;
          text-align: center;
        }

        .round-score-display.hidden {
          display: none;
        }

        .score-history {
          border-top: 1px solid #eee;
          padding-top: 1rem;
        }

        .round-history-item {
          font-size: 0.9rem;
          border-bottom: 1px solid #f0f0f0;
          padding-bottom: 0.25rem;
        }

        .round-history-item:last-child {
          border-bottom: none;
        }

        .guess-input-container {
          display: flex;
          gap: 0.75rem;
          align-items: center;
          justify-content: flex-start;
          margin: 1rem 0;
        }

        .guess-input-container.showcase-centered {
          justify-content: center;
          max-width: 400px;
          margin: 1rem auto;
        }

        .guess-input-container input {
          flex: 1;
          min-width: 200px;
        }

        .guess-input-container button {
          font-size: 0.8rem;
          font-weight: bold;
          font-family: 'Capriola', sans-serif;
          padding: 0.4rem 0.6rem;
          background: #dc3545;
          border: none;
          border-radius: 12px;
          color: white;
          transition: background-color 0.2s ease;
          height: fit-content;
        }

        .guess-input-container button:hover {
          background: #c82333;
        }

        .catalog-price-input {
          display: flex;
          gap: 0.5rem;
          align-items: center;
          justify-content: flex-start;
          border: 0px dashed #dc3545;
          background: rgb(245, 245, 245);
          padding: 0.6rem 0.8rem;
          border-radius: 12px;
          width: fit-content;
          height: 1.75rem;
          position: relative;
        }

        .catalog-price-input::before {
          content: "$";
          font-size: 1.5rem;
          font-weight: bold;
          font-family: 'Knewave', cursive;
          color: #2c3e50;
          margin-right: 0.1rem;
          line-height: 1;
        }

        .catalog-price-input input {
          font-size: 1.5rem;
          font-weight: bold;
          font-family: 'Knewave', cursive;
          color: #2c3e50;
          border: none;
          background: transparent;
          text-align: left;
          width: 30px;
          padding: 0;
          outline: none;
          line-height: 1;
          margin: 0;
        }

        .catalog-price-input input::placeholder {
          color: #7f8c8d;
          font-size: 1.5rem;
          font-weight: bold;
          font-family: 'Knewave', cursive;
        }
    .round-score-display { background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid #007acc; }
    .total-score-display { background: #e7f3ff; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: center; }
    .score-history { margin-top: 1rem; }
    .score-history-item { display: flex; justify-content: between; padding: 0.5rem 0; border-bottom: 1px solid #eee; }
    .score-history-item:last-child { border-bottom: none; }
    input { padding: 0.5rem; font-size: 1rem; margin-top: 1rem; width: 150px; }
    button { padding: 0.5rem 1rem; font-size: 1rem; margin-top: 1rem; cursor: pointer; }
    .feedback { margin-top: 1rem; font-weight: bold; }
    .difference { margin-top: 0.5rem; font-size: 1.2rem; color: #666; }
    .guesses-remaining { margin-top: 0.5rem; color: #888; font-size: 0.9rem; }
    .round-header { background: #ffffff; color: rgb(255, 255, 255); padding: 0.2rem 2rem; margin: -2rem -2rem 0rem -2rem; border-radius: 27px 27px 0 0; }
    .round-header h2 { 
      font-family: "Lexend", sans-serif; 
      margin: 0.1rem 0; 
      font-size: 3.5rem; 
      color: #999999; 
      text-shadow: 4px 4px 1px rgba(15, 15, 15, 0.8);
      font-weight: 700;
    }
    .game-subtitle { font-size: 0.9rem; margin: 0; color: #555; font-weight: normal; line-height: 1.6; }
    
    .progress-container { margin: 1rem 0; display: flex; justify-content: center; }
    .progress-line { display: flex; align-items: center; gap: 1rem; }
    .progress-point { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; font-family: 'Gabarito', sans-serif; transition: all 0.3s ease; }
    .progress-point.completed { background: #28a745; color: white; }
    .progress-point.current { background: #bdbdbd; color: #000; transform: scale(1.3); border: 0px solid #000000; box-shadow: 0 0 0 0px rgba(255, 255, 255, 0.3); }
    .progress-point.upcoming { background: #2b2c2c; color: white; }
    .progress-connector { width: 60px; height: 4px; background: #7a7a7a; border-radius: 2px; }
    .progress-connector.completed { background: #28a745; }
    .catalog-layout { display: flex; align-items: flex-start; gap: 2rem; margin: 2rem 0; width: fit-content; min-width: 600px; max-width: 100%; }
    .catalog-image { flex: 0 0 auto; }
    .catalog-image img { width: auto; height: 350px; max-width: 400px; object-fit: contain; border-radius: 8px; box-shadow: 3px 3px 8px rgba(0,0,0,0.25); }
    .catalog-details { flex: 1; text-align: left; padding: 0rem 0; min-height: 350px; min-width: 300px; }
    .product-title-container { margin-bottom: 0.6rem; }
    .product-titles { text-align: center; }
    .catalog-details h3 { margin-top: 0rem; margin-bottom: 0.7rem; font-size: 2.5rem; color: #333; font-family: 'Gabarito', sans-serif; font-weight: bold; }
    .catalog-details h4 { margin-top: -0.5rem; margin-bottom: 0.3rem; font-size: 1.5rem; color: #555; font-family: 'Gabarito', sans-serif; font-weight: normal; }
    #showcaseTitle { margin-top: 0rem; margin-bottom: 0.7rem; font-size: 2.8rem; color: #5a5a5a; font-family: 'Gabarito', sans-serif; font-weight: bold; }
    .showcase-title-container { display: flex; align-items: center; justify-content: space-between; margin-top: 1.5rem; margin-bottom: 0.7rem; }
    .showcase-title-container h3 { margin: 0; font-size: 2.5rem; color: #333; font-family: 'Gabarito', sans-serif; font-weight: bold; }
    .showcase-navigation-group { 
      display: flex; 
      align-items: center; 
      justify-content: center;
      gap: 0rem; 
      background: #d8d8d8; 
      border: 1px solid #e9ecef; 
      border-radius: 8px; 
      padding: 0rem 0rem; 
    }
    .gallery-counter { 
      font-size: 1rem; 
      color: #414141; 
      font-weight: bold; 
      text-align: center; 
      margin: 0; 
      padding: 0 0rem; 
      line-height: 1rem; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      min-height: 2rem;
      height: 2rem;
    }
    .catalog-details p { margin: 1rem 0 1.5rem 0; line-height: 1.5; color: #555; }
    .showcase-items { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0; }
    .showcase-item { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; }
    .showcase-item img { width: 100%; max-width: 120px; border-radius: 4px; }
    .showcase-gallery { display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 1rem 0; }
    .showcase-navigation { display: flex; align-items: center; justify-content: center; gap: 2rem; margin: 1rem 0; }
    .gallery-content { display: flex; align-items: flex-start; gap: 2rem; max-width: 600px; }
    .gallery-image { width: auto; height: 200px; max-width: 300px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .gallery-info { text-align: left; flex: 1; padding: 1rem 0; }
    .gallery-info h4 { margin-top: 0; font-size: .5rem; color: #000000; }
    .gallery-info p { margin: 0.5rem 0; line-height: 1; color: #555; }
    .gallery-nav { 
      background: transparent; 
      color: #666; 
      border: none; 
      padding: 0rem; 
      cursor: pointer; 
      font-size: 2.5rem; 
      line-height: 1; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      min-height: 2rem; 
      min-width: 3rem; 
      height: 2rem;
      vertical-align: middle;
      transform: translateY(-0.8rem);
    }
    .gallery-nav:hover { color: #333; }
    .gallery-nav:disabled { color: #ffffff; cursor: not-allowed; }
    .store-info { display: flex; align-items: center; justify-content: flex-start; gap: 0.5rem; margin: 0.2rem 0; }
    .store-logo { height: 24px; width: auto; max-width: 80px; object-fit: contain; }
    .store-name { font-size: 0.9rem; color: #666; }
    #itemDescription, #galleryDescription { font-family: 'Koh Santepheap', serif; font-weight: 400; font-size: 0.9rem; font-style: normal; max-height: 120px; overflow: hidden; transition: max-height 0.3s ease; cursor: pointer; position: relative; }
    #itemDescription:hover, #galleryDescription:hover { max-height: none; overflow: auto; }
    #itemDescription::after, #galleryDescription::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 20px; background: linear-gradient(transparent, rgba(255,255,255,0.9)); pointer-events: none; }
    #itemDescription:hover::after, #galleryDescription:hover::after { display: none; }
    .score-text { font-weight: bold; font-size: 1.1rem; }
    .score-excellent { color: #006400; } /* Dark green for 900-1000+ */
    .score-great { color: #228b22; } /* Green for 800-899 */
    .score-good { color: #32cd32; } /* Lime green for 700-799 */
    .score-okay { color: #ffa500; } /* Orange for 500-699 */
    .score-poor { color: #ff4500; } /* Red orange for 300-499 */
    .score-bad { color: #dc143c; } /* Crimson for 100-299 */
    .score-terrible { color: #8b0000; } /* Dark red for 0-99 */
    
    /* Temperature-based feedback colors */
    .temp-ice-cold { color: #4169e1; font-weight: bold; } /* Blue for ICE COLD */
    .temp-cold { color: #6495ed; font-weight: bold; } /* Cornflower blue for COLD */
    .temp-warm { color: #ffa500; font-weight: bold; } /* Orange for WARM */
    .temp-very-warm { color: #ff6347; font-weight: bold; } /* Tomato for VERY WARM */
    .temp-red-hot { color: #ff0000; font-weight: bold; } /* Red for RED HOT */
    
    /* Quick Preview Controls */
    .quick-preview-controls {
      margin: 1rem 0;
      text-align: center;
    }
    .preview-toggle-btn {
      background: #007acc;
      color: white;
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
    }
    .preview-toggle-btn:hover {
      background: #005a99;
    }
    .preview-round-nav {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .preview-round-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .preview-round-btn:hover {
      background: #1e7e34;
    }
    .preview-exit-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .preview-exit-btn:hover {
      background: #c82333;
    }
    
    .game-complete-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem auto;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .game-complete-container h3 {
      margin-top: 0;
      color: #28a745;
      font-size: 1.8rem;
    }
    
    .preview-navigation {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      display: none;
      text-align: center;
    }
    .preview-navigation.active {
      display: block;
    }
    .preview-nav-buttons {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .preview-nav-btn {
      background: #007acc;
      color: white;
      border: none;
      padding: 0.3rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-block;
    }
    .preview-nav-btn:hover {
      background: #005a99;
    }
    .preview-nav-btn.current {
      background: #28a745;
    }
    
    .final-score {
      font-size: 1.3rem;
      color: #495057;
      margin: 1rem 0;
    }
    .final-grade {
      font-size: 1.5rem;
      color: #007acc;
      margin: 1rem 0;
      font-weight: bold;
    }
    .comeback-message {
      color: #6c757d;
      font-style: italic;
      margin-top: 1.5rem;
    }
    
    .image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
    .modal-content { display: flex; justify-content: center; align-items: center; height: 100%; padding: 20px; }
    .modal-image { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
    .close-modal:hover { color: #ccc; }
    .clickable-image { cursor: pointer; transition: opacity 0.2s ease; }
    .clickable-image:hover { opacity: 0.9; }
    .hidden { display: none; }
    
    /* Portrait orientation - stack layout vertically */
    @media (orientation: portrait) {
      .game-container { 
        flex-direction: column; 
        gap: 1.5rem; 
      }
      
      .game,
      .score-sidebar { 
        width: 100%; 
        flex: none;
        order: 2; 
        box-sizing: border-box;
      }
      
      .game {
        order: 1;
      }
    }

    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      body { 
        padding: 1rem; 
        background-size: auto;
      }
      
      /* Stack layout vertically on mobile */
      .game-container { 
        flex-direction: column; 
        gap: 1rem; 
        max-width: 100%;
        margin: 0 auto;
        box-sizing: border-box;
      }
      
      /* Make game area full width */
      .game { 
        padding: 1.5rem; 
        border-radius: 20px; 
        box-shadow: 8px 8px 0.25px rgba(0,0,0,0.5); 
      }
      
      /* Round header mobile adjustments */
      .round-header { 
        margin: -1.5rem -1.5rem 0rem -1.5rem; 
        padding: 0.2rem 1.5rem; 
        border-radius: 17px 17px 0 0; 
      }
      
      /* Mobile title sizing - shrink instead of wrap */
      .round-header h2 { 
        font-size: 2.2rem; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
      }
      
      /* Stack sidebar below game on mobile */
      .score-sidebar { 
        width: 100%; 
        order: 2; 
        padding: 1rem; 
        box-shadow: 8px 8px 1px rgba(0,0,0,0.5); 
        box-sizing: border-box;
        max-width: 100%;
        overflow-x: hidden;
      }
      
      /* Ensure all sidebar content is properly contained */
      .score-sidebar * {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Prevent any text overflow */
      .round-history-item,
      .score-history,
      .game-instructions {
        max-width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }
      
      /* Center score tracker and round history content */
      .score-sidebar {
        text-align: center;
      }
      
      .score-sidebar h3,
      .score-sidebar div {
        text-align: center;
      }
      
      .score-history,
      .round-history-item {
        text-align: center;
      }
      
      /* Center the progress tracker */
      .progress-tracker {
        justify-content: center;
      }
      
      /* Stack catalog layout vertically */
      .catalog-layout { 
        flex-direction: column; 
        gap: 1rem; 
        margin: 1rem 0; 
        min-width: unset; 
        width: 100%; 
        align-items: center; 
      }
      
      /* Make images responsive */
      .catalog-image { 
        flex: none; 
        width: 100%; 
        text-align: center; 
      }
      
      .catalog-image img { 
        width: 100%; 
        height: auto; 
        max-width: 300px; 
        max-height: 300px; 
        object-fit: contain; 
      }
      
      /* Full width details on mobile */
      .catalog-details { 
        min-width: unset; 
        min-height: unset; 
        width: 100%; 
        text-align: center; 
        padding: 0.5rem 0; 
      }
      
      /* Smaller fonts on mobile */
      .catalog-details h3 { 
        font-size: 1.5rem; 
      }
      
      .catalog-details h4 { 
        font-size: 1.2rem; 
      }
      
      /* Mobile-friendly input */
      .guess-input-container { 
        flex-direction: row; 
        gap: 0.5rem; 
        align-items: center; 
        justify-content: center;
        flex-wrap: nowrap;
      }
      
      .catalog-price-input { 
        width: auto; 
        min-width: 120px;
        flex: 1;
        max-width: 200px;
      }
      
      .catalog-price-input input { 
        font-size: 1.2rem; 
        padding: 0.8rem; 
      }
      
      /* Larger buttons for touch */
      button { 
        min-height: 44px; 
        font-size: 1rem; 
        padding: 0.8rem 1.5rem; 
      }
      
      /* Progress indicator adjustments */
      .progress-point { 
        width: 35px; 
        height: 35px; 
        font-size: 0.8rem; 
      }
      
      .progress-connector { 
        width: 40px; 
      }
      
      /* Gallery navigation for showcases */
      .gallery-nav { 
        min-width: 60px; 
        min-height: 60px; 
        font-size: 2.5rem; 
      }
      
      /* Store info adjustments */
      .store-info { 
        justify-content: center; 
      }
      
      .store-logo { 
        width: 35px; 
        height: 35px; 
      }
      
      /* Description hover to tap for mobile */
      #itemDescription:hover::after, #galleryDescription:hover::after { 
        display: block; 
      }
      
      #itemDescription, #galleryDescription { 
        cursor: default; 
      }
      
      /* Preview navigation mobile adjustments */
      .preview-nav-buttons { 
        gap: 0.3rem; 
      }
      
      .preview-nav-btn { 
        padding: 0.5rem 0.6rem; 
        font-size: 0.8rem; 
      }
    }
    
    /* Small mobile phones */
    @media (max-width: 480px) {
      body { 
        padding: 0.5rem; 
      }
      
      .game { 
        padding: 1rem; 
        border-radius: 15px; 
      }
      
      /* Round header small mobile adjustments */
      .round-header { 
        margin: -1rem -1rem 0rem -1rem; 
        padding: 0.2rem 1rem; 
        border-radius: 12px 12px 0 0; 
      }
      
      /* Even smaller title for small mobile */
      .round-header h2 { 
        font-size: 1.8rem; 
      }
      
      .catalog-details h3 { 
        font-size: 1.3rem; 
      }
      
      .catalog-details h4 { 
        font-size: 1.1rem; 
      }
      
      .catalog-image img { 
        max-width: 250px; 
        max-height: 250px; 
      }
      
      .catalog-price-input { 
        width: 180px; 
      }
      
      .progress-point { 
        width: 30px; 
        height: 30px; 
        font-size: 0.7rem; 
      }
      
      .progress-connector { 
        width: 30px; 
      }
    }

    /* Small portrait devices - edge to edge display */
    @media (orientation: portrait) and (max-width: 768px) {
      body { 
        padding: 0; 
        margin: 0;
      }
      
      .game { 
        border-radius: 0;
        border: none;
        box-shadow: none;
        margin: 0;
        padding: 1rem;
      }
      
      .score-sidebar {
        border-radius: 0;
        border: none;
        box-shadow: none;
        margin: 0;
        padding: 1rem;
      }
      
      /* Remove container margins */
      .game-container {
        margin: 0;
        gap: 0;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game">
      <div class="round-header">
        <h2>NAME YOUR PRICE</h2>
        <div class="progress-container">
          <div class="progress-line">
            <div class="progress-point current" id="point1">1</div>
            <div class="progress-connector" id="connector1"></div>
            <div class="progress-point upcoming" id="point2">2</div>
            <div class="progress-connector" id="connector2"></div>
            <div class="progress-point upcoming" id="point3">3</div>
            <div class="progress-connector" id="connector3"></div>
            <div class="progress-point upcoming" id="point4">🏆</div>
          </div>
        </div>
        
        <!-- Preview Navigation (hidden by default) -->
        <div class="preview-navigation" id="previewNavigation">
          <div style="font-weight: bold; margin-bottom: 0.5rem;">📅 Preview Mode</div>
          <div class="preview-nav-buttons">
            <a href="?" class="preview-nav-btn">Today</a>
            <a href="?preview=1" class="preview-nav-btn">Tomorrow</a>
            <a href="?preview=2" class="preview-nav-btn">+2 Days</a>
            <a href="?preview=3" class="preview-nav-btn">+3 Days</a>
            <a href="?preview=7" class="preview-nav-btn">+1 Week</a>
            <a href="?preview=30" class="preview-nav-btn">+1 Month</a>
            <a href="?preview=-1" class="preview-nav-btn">Yesterday</a>
          </div>
        </div>
        
        <!-- Quick Preview Button -->
        <div class="quick-preview-controls" id="quickPreviewControls" style="display: none;">
          <button id="togglePreviewMode" class="preview-toggle-btn" onclick="togglePreviewMode()">🔍 Quick Preview All Rounds</button>
          <div class="preview-round-nav" id="previewRoundNav" style="display: none;">
            <button onclick="previewRound(1)" class="preview-round-btn">Round 1</button>
            <button onclick="previewRound(2)" class="preview-round-btn">Round 2</button>
            <button onclick="previewRound(3)" class="preview-round-btn">Round 3</button>
            <button onclick="previewRound(4)" class="preview-round-btn">Showcase</button>
            <button onclick="exitPreviewMode()" class="preview-exit-btn">Exit Preview</button>
          </div>
        </div>
      </div>

    <!-- Single Item Display -->
    <div id="singleItemView">
      <div class="catalog-layout">
        <div class="catalog-image">
          <img id="itemImage" class="clickable-image" src="" alt="Item" onclick="openImageModal(this.src)">
        </div>
        <div class="catalog-details">
          <div class="product-title-container">
            <h3 id="itemBrand">Loading...</h3>
            <h4 id="itemTitle">Loading...</h4>
          </div>
          <div class="store-info">
            <img id="storeLogoSingle" class="store-logo" src="" alt="Store">
            <span id="storeNameSingle" class="store-name">Store</span>
          </div>
          <div class="guess-input-container">
            <div class="catalog-price-input">
              <input type="number" id="guessInput" placeholder="0.00" />
            </div>
            <button onclick="makeGuess()" id="guessButton">Submit</button>
          </div>
          <p id="itemDescription">Loading item...</p>
        </div>
      </div>
    </div>

    <!-- Showcase Display -->
    <div id="showcaseView" class="hidden">
      <div class="showcase-title-container">
        <h3 id="showcaseTitle">Showcase Showdown</h3>
      </div>
      
      <div class="showcase-navigation-group">
        <button class="gallery-nav" id="prevBtn" onclick="navigateGallery(-1)">‹</button>
        <div class="gallery-counter">
          <span id="galleryCounter">Item 1 of 3</span>
        </div>
        <button class="gallery-nav" id="nextBtn" onclick="navigateGallery(1)">›</button>
      </div>
      
      <div class="catalog-layout">
        <div class="catalog-image">
          <img id="galleryImage" class="clickable-image" src="" alt="Showcase Item" onclick="openImageModal(this.src)">
        </div>
        <div class="catalog-details">
          <div class="product-title-container">
            <h3 id="galleryBrand">Item Brand</h3>
            <h4 id="galleryTitle">Item Title</h4>
          </div>
          <div class="store-info">
            <img id="galleryStoreLogo" class="store-logo" src="" alt="Store">
            <span id="galleryStoreName" class="store-name">Store</span>
          </div>
          <p id="galleryDescription">Item description</p>
        </div>
      </div>
      
      <p><strong>Guess the total price of all three items!</strong></p>
      <div class="guess-input-container showcase-centered">
        <div class="catalog-price-input">
          <input type="number" id="guessInputShowcase" placeholder="0.00" />
        </div>
        <button onclick="makeGuess()" id="guessButtonShowcase">Submit</button>
      </div>
    </div>

    <div class="feedback" id="feedback"></div>
    <div class="guesses-remaining" id="guessesRemaining">Guesses remaining: 3</div>
    <div id="result"></div>
    </div>

    <!-- Score Sidebar -->
    <div class="score-sidebar">
      <h3>📊 Score Tracker</h3>
      <div class="total-score-display">
        <div><strong>Total Score</strong></div>
        <div id="sidebarTotalScore" style="font-size: 1.5rem; color: #007acc; font-weight: bold;">0</div>
        <div style="font-size: 0.9rem; color: #666;">out of 5,000 points</div>
      </div>
      
      <div class="round-score-display hidden" id="currentRoundScore">
        <div><strong>Round <span id="currentRoundNumber">1</span> Result</strong></div>
        <div id="roundScoreValue" class="score-text" style="font-size: 1.3rem; margin: 0.5rem 0;">0 points</div>
        <div id="roundScoreDetails" style="font-size: 0.9rem; color: #666;"></div>
      </div>
      
      <div class="score-history">
        <div style="font-weight: bold; margin-bottom: 0.5rem;">Round History</div>
        <div id="scoreHistoryList"></div>
      </div>
      
      <!-- Game Instructions Box -->
      <div class="game-instructions">
        <button class="how-to-play-btn" onclick="toggleHowToPlay()">📋 How to Play ▼</button>
        <div id="howToPlayContent" class="how-to-play-content" style="display: none;">
          <p class="game-subtitle">You’ll have 2 chances to guess the retail price of each item. Points are awarded based on how close your final guess is to the actual price. Play through 3 single-item rounds, then finish with a Showcase round where you guess the total of multiple items. The closer you are, the higher your score!</p>
        </div>
      </div>
      
      <!-- Contact Us Section -->
      <div class="game-instructions" style="margin-top: 1rem;">
        <button class="contact-us-btn" onclick="toggleContactUs()">📧 Contact Us ▼</button>
        <div id="contactUsContent" class="how-to-play-content" style="display: none;">
          <p class="game-subtitle">Made by Luke Machaj</p>
          <p class="game-subtitle">Email me at <a href="mailto:nameyourpriceluke@gmail.com" style="color: #007acc;">nameyourpriceluke@gmail.com</a> with any inquiries</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="image-modal">
    <span class="close-modal" onclick="closeImageModal()">&times;</span>
    <div class="modal-content">
      <img id="modalImage" class="modal-image" src="" alt="Full Size Image">
    </div>
  </div>

  <script>
    let gameData = {};
    let currentRound = 1;
    let maxRounds = 4; // 3 single items + 1 showcase
    let currentItem = null;
    let currentShowcase = null;
    let currentGalleryIndex = 0; // Track which item in showcase is being viewed
    let guesses = [];
    let maxGuesses = 2;
    let gameOver = false;
    let totalScore = 0;
    let roundScores = [];

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAtu2q3L9Z3HrFidfUvPwnTwqEP8il1r2o",
      authDomain: "the-cost-is-correct.firebaseapp.com",
      projectId: "the-cost-is-correct",
      storageBucket: "the-cost-is-correct.firebasestorage.app",
      messagingSenderId: "853113000023",
      appId: "1:853113000023:web:6c508d56412993f8bd9312"
    };

    // Initialize Firebase (only if config is provided)
    let db = null;
    console.log('Checking Firebase configuration...');
    console.log('API Key present:', !!firebaseConfig.apiKey);
    console.log('Firebase object available:', typeof firebase !== 'undefined');
    
    if (firebaseConfig.apiKey) {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log('✅ Firebase initialized successfully!');
        
        // Test connection with more detailed logging
        console.log('Testing Firestore connection...');
        db.collection('daily_scores').limit(1).get()
          .then((querySnapshot) => {
            console.log('✅ Firestore connection successful!');
            console.log('Documents found:', querySnapshot.size);
          })
          .catch(error => {
            console.error('❌ Firestore connection failed:');
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            console.error('Full error:', error);
          });
      } catch (initError) {
        console.error('❌ Firebase initialization failed:');
        console.error('Init error:', initError);
      }
    } else {
      console.log('❌ Firebase API key not found');
    }

    // How to Play toggle function
    function toggleHowToPlay() {
      const content = document.getElementById('howToPlayContent');
      const button = document.querySelector('.how-to-play-btn');
      
      if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        button.textContent = '📋 How to Play ▲';
      } else {
        content.style.display = 'none';
        button.textContent = '📋 How to Play ▼';
      }
    }

    function toggleContactUs() {
      const content = document.getElementById('contactUsContent');
      const button = document.querySelector('.contact-us-btn');
      
      if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        button.textContent = '📧 Contact Us ▲';
      } else {
        content.style.display = 'none';
        button.textContent = '📧 Contact Us ▼';
      }
    }

    // Daily Average Functions
    async function submitScoreToDatabase(score) {
      console.log('📊 submitScoreToDatabase called with score:', score);
      console.log('Database object exists:', !!db);
      
      if (!db) {
        console.log('❌ Firebase not configured - score not submitted');
        return null;
      }
      
      try {
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
        console.log('📅 Submitting score for date:', today);
        
        // Submit the score
        console.log('💾 Adding score to Firestore...');
        await db.collection('daily_scores').add({
          score: score,
          date: today,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('✅ Score submitted successfully!');

        // Get today's scores for average calculation
        const todayScores = await db.collection('daily_scores')
          .where('date', '==', today)
          .get();

        const scores = todayScores.docs.map(doc => doc.data().score);
        const average = scores.reduce((a, b) => a + b, 0) / scores.length;
        
        // Get historical data for chart (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
        const startDate = sevenDaysAgo.toISOString().split('T')[0];
        
        console.log('📈 Fetching historical data from:', startDate);
        const historicalScores = await db.collection('daily_scores')
          .where('date', '>=', startDate)
          .orderBy('date')
          .get();

        // Group scores by date and calculate daily averages
        const dailyAverages = {};
        historicalScores.docs.forEach(doc => {
          const data = doc.data();
          if (!dailyAverages[data.date]) {
            dailyAverages[data.date] = [];
          }
          dailyAverages[data.date].push(data.score);
        });

        // Calculate averages for each day
        const chartData = [];
        for (let i = 6; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          
          if (dailyAverages[dateStr]) {
            const dayScores = dailyAverages[dateStr];
            const dayAverage = dayScores.reduce((a, b) => a + b, 0) / dayScores.length;
            chartData.push({
              date: dateStr,
              average: Math.round(dayAverage),
              playerCount: dayScores.length
            });
          } else {
            chartData.push({
              date: dateStr,
              average: null,
              playerCount: 0
            });
          }
        }
        
        // Add dummy data if we don't have enough historical data
        const hasEnoughData = chartData.filter(day => day.average !== null).length >= 3;
        if (!hasEnoughData) {
          console.log('📊 Adding dummy historical data for chart demonstration');
          // Generate dummy data for the past 7 days
          for (let i = 0; i < chartData.length; i++) {
            if (chartData[i].average === null) {
              // Generate realistic scores between 2000-4500
              const dummyAverage = Math.floor(Math.random() * 2500) + 2000;
              const dummyPlayers = Math.floor(Math.random() * 50) + 10;
              chartData[i] = {
                date: chartData[i].date,
                average: dummyAverage,
                playerCount: dummyPlayers
              };
            }
          }
        }
        
        return {
          average: Math.round(average),
          totalPlayers: scores.length,
          historicalData: chartData,  // Changed from chartData to historicalData
          userScore: score
        };
      } catch (error) {
        console.error('Error submitting score:', error);
        return null;
      }
    }

    // Create score trend chart
    function createScoreChart(chartData, userScore) {
      const canvas = document.getElementById('scoreChart');
      if (!canvas) return;

      // Prepare data for Chart.js
      const labels = chartData.map(day => {
        const date = new Date(day.date);
        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'numeric', day: 'numeric' });
      });

      const averages = chartData.map(day => day.average);
      const todayIndex = chartData.length - 1;

      // Create chart
      new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Daily Average',
            data: averages,
            borderColor: '#007acc',
            backgroundColor: 'rgba(0, 122, 204, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#007acc',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 6
          }, {
            label: 'Your Score',
            data: new Array(todayIndex).fill(null).concat([userScore]),
            borderColor: '#ff6b35',
            backgroundColor: '#ff6b35',
            borderWidth: 0,
            pointBackgroundColor: '#ff6b35',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 3,
            pointRadius: 10,
            showLine: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20
              }
            },
            title: {
              display: true,
              text: '7-Day Score Trend',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: 20
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 5000,
              title: {
                display: true,
                text: 'Score'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Date'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.1)'
              }
            }
          },
          elements: {
            point: {
              hoverRadius: 8
            }
          }
        }
      });
    }
    
    let roundHistory = [];

    // Load items and set up daily challenge
    async function loadItems() {
      try {
        // Add cache-busting parameter to ensure fresh data
        const cacheBuster = new Date().getTime();
        const response = await fetch(`items.json?v=${cacheBuster}`);
        gameData = await response.json();
        
        // Debug: Check what we actually loaded
        console.log('Loaded gameData:', gameData);
        console.log('First single item from JSON:', gameData.single_items[0]);
        console.log('First item keys:', Object.keys(gameData.single_items[0]));
        
        // Auto-calculate showcase total prices from individual item prices
        if (gameData.showcases) {
          gameData.showcases.forEach(showcase => {
            if (showcase.items && showcase.items.length > 0) {
              showcase.total_price = showcase.items.reduce((total, item) => {
                return total + (item.price || 0);
              }, 0);
            }
          });
        }
        
        setupDailyChallenge();
      } catch (error) {
        console.error('Could not load items:', error);
        // Fallback data
        gameData = {
          single_items: [{
            id: 1,
            title: "Microwave Oven",
            description: "Standard countertop microwave, 1000W",
            price: 120,
            image: "https://images.unsplash.com/photo-1574269909862-7e1d70bb8078?w=400&h=300&fit=crop"
          }],
          showcases: [{
            id: 1,
            title: "Kitchen Bundle",
            items: [{ title: "Toaster", price: 50, image: "", description: "2-slice toaster" }],
            total_price: 50
          }]
        };
        setupDailyChallenge();
      }
    }

    // Use today's date to pick items for the day
    function setupDailyChallenge() {
      // Check for preview mode
      const urlParams = new URLSearchParams(window.location.search);
      const previewDays = parseInt(urlParams.get('preview')) || 0;
      
      const today = new Date();
      const targetDate = new Date(today.getTime() + (previewDays * 24 * 60 * 60 * 1000));
      const dayOfYear = Math.floor((targetDate - new Date(targetDate.getFullYear(), 0, 0)) / 86400000);
      
      // Add preview indicator if in preview mode
      if (previewDays !== 0) {
        const previewDate = targetDate.toLocaleDateString();
        const previewText = previewDays > 0 ? `${previewDays} days in the future` : `${Math.abs(previewDays)} days in the past`;
        document.querySelector('.game-subtitle').innerHTML = 
          `<span style="color: #ffcc00; font-weight: bold;">🔍 PREVIEW MODE: ${previewText} (${previewDate})</span><br>` + 
          document.querySelector('.game-subtitle').textContent;
      }
      
      // Filter out items without proper data (empty title/brand, no price, or no image)
      const validSingleItems = gameData.single_items.filter(item => 
        ((item.brand && item.brand.trim() !== '') || (item.title && item.title.trim() !== '')) && 
        item.price > 0 && 
        item.image && item.image.trim() !== ''
      );
      
      const validShowcases = gameData.showcases.filter(showcase => 
        showcase.title && showcase.title.trim() !== '' && 
        showcase.total_price > 0 &&
        showcase.items && showcase.items.length > 0
      );
      
      // Pick 3 single items and 1 showcase for today from valid items only
      // Use dayOfYear * 3 to ensure each day gets completely unique items
      const singleItemsToday = [];
      for (let i = 0; i < 3; i++) {
        const itemIndex = (dayOfYear * 3 + i) % validSingleItems.length;
        singleItemsToday.push(validSingleItems[itemIndex]);
      }
      const showcaseIndex = dayOfYear % validShowcases.length;
      const showcaseToday = validShowcases[showcaseIndex];
      
      gameData.todaysGame = {
        rounds: [...singleItemsToday, showcaseToday]
      };
      
      // Show preview navigation if URL has preview parameter or if it's in preview mode
      const currentPreview = parseInt(urlParams.get('preview')) || 0;
      const previewNav = document.getElementById('previewNavigation');
      
      if (urlParams.has('preview') || currentPreview !== 0) {
        previewNav.classList.add('active');
        
        // Highlight current preview option
        document.querySelectorAll('.preview-nav-btn').forEach(btn => {
          btn.classList.remove('current');
          const btnUrl = new URL(btn.href);
          const btnPreview = parseInt(btnUrl.searchParams.get('preview')) || 0;
          if (btnPreview === currentPreview) {
            btn.classList.add('current');
          }
        });
      }
      
      startRound();
    }

    // Calculate percentage-based score (more granular - out of 1000 points)
    function calculateScore(guess, actualPrice) {
      // Use absolute percentage difference for mirrored scoring (no more bust)
      const percentageOff = Math.abs((guess - actualPrice) / actualPrice);
      
      if (percentageOff === 0) return 1000; // Perfect guess
      
      // Deduct 10 points per 0.1% off (so 1% off = -100 points)
      // percentageOff is a decimal (e.g., 0.05 = 5%), multiply by 1000 to get points deducted
      const pointsDeducted = Math.floor(percentageOff * 1000);
      const score = Math.max(0, 1000 - pointsDeducted);
      
      return score;
    }

    // Show formatted result message
    function showResultMessage(htmlContent) {
      // Create modal backdrop
      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
        align-items: center; z-index: 1000;
      `;
      
      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white; padding: 2rem; border-radius: 12px; 
        max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif; line-height: 1.6;
      `;
      
      // Determine button text based on game state
      let buttonText = 'Continue';
      if (currentRound < maxRounds) {
        buttonText = currentRound === 3 ? 'Start Showcase!' : 'Next Round';
      } else {
        buttonText = 'View Final Results';
      }
      
      const actionButton = document.createElement('button');
      actionButton.textContent = buttonText;
      actionButton.style.cssText = `
        background: #dc2626; color: white; border: none; padding: 0.75rem 1.5rem; 
        border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: bold; 
        margin-top: 1.5rem; transition: background 0.2s; display: block; width: 100%;
      `;
      
      // Add hover effect
      actionButton.addEventListener('mouseenter', () => {
        actionButton.style.background = '#b91c1c';
      });
      actionButton.addEventListener('mouseleave', () => {
        actionButton.style.background = '#dc2626';
      });
      
      modal.innerHTML = htmlContent;
      modal.appendChild(actionButton);
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      
      // Function to close modal and continue game
      const proceedToNext = () => {
        backdrop.remove();
        
        if (currentRound < maxRounds) {
          // Start next round
          currentRound++;
          startRound();
        } else {
          // Show final results
          showFinalResults();
        }
      };
      
      actionButton.addEventListener('click', proceedToNext);
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) proceedToNext();
      });
    }

    // Get CSS class based on score value
    function getScoreColorClass(score) {
      if (score >= 900) return 'score-excellent';
      if (score >= 800) return 'score-great';
      if (score >= 700) return 'score-good';
      if (score >= 500) return 'score-okay';
      if (score >= 300) return 'score-poor';
      if (score >= 100) return 'score-bad';
      return 'score-terrible';
    }

    // Start a new round
    function startRound() {
      if (currentRound > maxRounds) {
        showFinalResults();
        return;
      }
      
      guesses = [];
      gameOver = false;
      currentGalleryIndex = 0; // Reset gallery index for new round
      document.getElementById('guessInput').value = '';
      document.getElementById('guessInputShowcase').value = '';
      document.getElementById('feedback').textContent = '';
      document.getElementById('result').textContent = '';
      document.getElementById('guessesRemaining').textContent = 'Guesses remaining: 2';
      
      // Hide current round score display when starting new round
      document.getElementById('currentRoundScore').classList.add('hidden');
      
      const roundData = gameData.todaysGame.rounds[currentRound - 1];
      
      if (currentRound <= 3) {
        // Single item round
        currentItem = roundData;
        currentShowcase = null;
        setupSingleItemRound();
      } else {
        // Showcase round
        currentShowcase = roundData;
        currentItem = null;
        setupShowcaseRound();
      }
      
      updateRoundDisplay();
    }

    function setupSingleItemRound() {
      document.getElementById('singleItemView').classList.remove('hidden');
      document.getElementById('showcaseView').classList.add('hidden');
      
      document.getElementById('itemImage').src = currentItem.image;
      
      // Handle both old format (title only) and new format (brand + title)
      console.log('Current item:', currentItem); // Debug log
      console.log('Brand field value:', currentItem.brand); // Debug - exact brand value
      console.log('Title field value:', currentItem.title); // Debug - exact title value
      console.log('All item keys:', Object.keys(currentItem)); // Debug - all properties
      
      // Check if this item has the new format (both brand and title fields)
      const hasBrand = currentItem.brand && currentItem.brand.trim() !== '';
      const hasTitle = currentItem.title && currentItem.title.trim() !== '';
      
      console.log('Has brand:', hasBrand, 'Has title:', hasTitle); // Debug
      
      if (hasBrand && hasTitle) {
        // New format with separate brand and title
        console.log('Using new format - Brand:', currentItem.brand, 'Title:', currentItem.title); // Debug
        document.getElementById('itemBrand').textContent = currentItem.brand.trim();
        document.getElementById('itemTitle').textContent = currentItem.title.trim();
      } else if (hasTitle) {
        // Legacy format - title contains full product name, split it
        console.log('Using legacy format for:', currentItem.title); // Debug
        const fullTitle = currentItem.title.trim();
        const parts = fullTitle.split(' ');
        if (parts.length >= 2) {
          document.getElementById('itemBrand').textContent = parts[0];
          document.getElementById('itemTitle').textContent = parts.slice(1).join(' ');
        } else {
          document.getElementById('itemBrand').textContent = fullTitle;
          document.getElementById('itemTitle').textContent = '';
        }
      } else {
        // Fallback
        console.log('Using fallback - no valid data found');
        document.getElementById('itemBrand').textContent = 'Unknown Brand';
        document.getElementById('itemTitle').textContent = 'Unknown Item';
      }
      
      document.getElementById('itemDescription').textContent = currentItem.description;
      
      // Display store information
      if (currentItem.store) {
        // Handle both string store names and store objects
        let storeName, storeLogo;
        if (typeof currentItem.store === 'string') {
          // If store is a string, look up the logo from the stores mapping
          storeName = currentItem.store;
          storeLogo = gameData.stores[currentItem.store] || 'images/logos/placeholder.png';
        } else {
          // If store is an object, use its properties directly
          storeName = currentItem.store.name;
          storeLogo = currentItem.store.logo;
        }
        
        document.getElementById('storeLogoSingle').src = storeLogo;
        document.getElementById('storeNameSingle').textContent = storeName;
      }
    }

    function setupShowcaseRound() {
      document.getElementById('singleItemView').classList.add('hidden');
      document.getElementById('showcaseView').classList.remove('hidden');
      
      document.getElementById('showcaseTitle').textContent = currentShowcase.title;
      
      // Reset gallery to first item
      currentGalleryIndex = 0;
      updateGalleryDisplay();
    }

    // Navigate through showcase gallery
    function navigateGallery(direction) {
      const newIndex = currentGalleryIndex + direction;
      if (newIndex >= 0 && newIndex < currentShowcase.items.length) {
        currentGalleryIndex = newIndex;
        updateGalleryDisplay();
      }
    }

    // Update the gallery display with current item
    function updateGalleryDisplay() {
      const currentGalleryItem = currentShowcase.items[currentGalleryIndex];
      
      document.getElementById('galleryImage').src = currentGalleryItem.image;
      
      // Handle both old format (title only) and new format (brand + title)
      if (currentGalleryItem.brand && currentGalleryItem.brand.trim() !== '' && currentGalleryItem.title && currentGalleryItem.title.trim() !== '') {
        // New format with separate brand and title
        document.getElementById('galleryBrand').textContent = currentGalleryItem.brand.trim();
        document.getElementById('galleryTitle').textContent = currentGalleryItem.title.trim();
      } else if (currentGalleryItem.title && currentGalleryItem.title.trim() !== '') {
        // Legacy format - try to split title into brand and product
        const fullTitle = currentGalleryItem.title.trim();
        const parts = fullTitle.split(' ');
        if (parts.length >= 2) {
          document.getElementById('galleryBrand').textContent = parts[0];
          document.getElementById('galleryTitle').textContent = parts.slice(1).join(' ');
        } else {
          document.getElementById('galleryBrand').textContent = fullTitle;
          document.getElementById('galleryTitle').textContent = '';
        }
      } else {
        // Fallback
        document.getElementById('galleryBrand').textContent = 'Unknown Brand';
        document.getElementById('galleryTitle').textContent = 'Unknown Item';
      }
      
      document.getElementById('galleryDescription').textContent = currentGalleryItem.description;
      
      // Update store info for the current item
      if (currentGalleryItem.store) {
        // Handle both string store names and store objects
        let storeName, storeLogo;
        if (typeof currentGalleryItem.store === 'string') {
          // If store is a string, look up the logo from the stores mapping
          storeName = currentGalleryItem.store;
          storeLogo = gameData.stores[currentGalleryItem.store] || 'images/logos/placeholder.png';
        } else {
          // If store is an object, use its properties directly
          storeName = currentGalleryItem.store.name;
          storeLogo = currentGalleryItem.store.logo;
        }
        
        document.getElementById('galleryStoreLogo').src = storeLogo;
        document.getElementById('galleryStoreName').textContent = storeName;
      }
      
      // Update counter
      document.getElementById('galleryCounter').textContent = 
        `Item ${currentGalleryIndex + 1} of ${currentShowcase.items.length}`;
      
      // Update navigation buttons
      document.getElementById('prevBtn').disabled = currentGalleryIndex === 0;
      document.getElementById('nextBtn').disabled = currentGalleryIndex === currentShowcase.items.length - 1;
    }

    function updateRoundDisplay() {
      const roundNumber = currentRound + 1;
      const roundTitle = roundNumber <= 3 ? `Round ${roundNumber}` : 'Showcase Showdown';
      document.getElementById('round-title').textContent = roundTitle;
      document.getElementById('progress-bar').style.width = `${(currentRound / 4) * 100}%`;
      document.getElementById('progress-text').textContent = `${currentRound}/4 Rounds Complete`;
      
      // Initialize/update sidebar
      updateSidebar();
    }

    function updateSidebar() {
      // Update total score
      document.getElementById('sidebarTotalScore').textContent = totalScore.toLocaleString();
      
      // Update score history
      const historyList = document.getElementById('scoreHistoryList');
      historyList.innerHTML = '';
      
      roundHistory.forEach((round, index) => {
        const roundDiv = document.createElement('div');
        roundDiv.className = 'round-history-item';
        roundDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin: 0.25rem 0;">
            <span>Round ${index + 1}${index === 3 ? ' (Showcase)' : ''}</span>
            <span class="${round.scoreClass}" style="font-weight: bold;">${round.score} pts</span>
          </div>
        `;
        historyList.appendChild(roundDiv);
      });
    }

    function showCurrentRoundScore(score, details, scoreClass) {
      const currentRoundElement = document.getElementById('currentRoundScore');
      const roundNumberElement = document.getElementById('currentRoundNumber');
      const scoreValueElement = document.getElementById('roundScoreValue');
      const scoreDetailsElement = document.getElementById('roundScoreDetails');
      
      roundNumberElement.textContent = currentRound + 1;
      scoreValueElement.textContent = `${score.toLocaleString()} points`;
      scoreValueElement.className = `score-text ${scoreClass}`;
      scoreDetailsElement.textContent = details;
      
      currentRoundElement.classList.remove('hidden');
    }

    function updateRoundDisplay() {
      // Update progress indicator
      for (let i = 1; i <= 4; i++) {
        const point = document.getElementById(`point${i}`);
        const connector = document.getElementById(`connector${i}`);
        
        if (i < currentRound) {
          // Completed rounds
          point.className = 'progress-point completed';
          if (connector) connector.className = 'progress-connector completed';
        } else if (i === currentRound) {
          // Current round
          point.className = 'progress-point current';
          if (connector) connector.className = 'progress-connector';
        } else {
          // Upcoming rounds
          point.className = 'progress-point upcoming';
          if (connector) connector.className = 'progress-connector';
        }
      }
    }

    // Initialize the game when page loads
    window.onload = loadItems;

    function makeGuess() {
      if (gameOver) return;
      
      // Get the appropriate input field based on current round
      const isShowcase = currentRound === 4;
      const inputId = isShowcase ? 'guessInputShowcase' : 'guessInput';
      const input = document.getElementById(inputId);
      const guess = parseInt(input.value);
      if (isNaN(guess)) return;

      guesses.push(guess);
      
      const actualPrice = currentItem ? currentItem.price : currentShowcase.total_price;

      // Check for exact match first
      if (guess === actualPrice) {
        document.getElementById('feedback').textContent = `Wow! You were right on the money!`;
        document.getElementById('guessesRemaining').textContent = '';
        endRound(true, actualPrice);
        return;
      }

      const remaining = maxGuesses - guesses.length;
      
      if (guesses.length < maxGuesses) {
        // Calculate how far off the guess is as a percentage
        const percentageOff = Math.abs(actualPrice - guess) / actualPrice;
        let underMessage = '';
        let tempClass = '';
        
        if (percentageOff >= 0.6) {
          underMessage = 'ICE COLD';
          tempClass = 'temp-ice-cold';
        } else if (percentageOff >= 0.29) {
          underMessage = 'COLD';
          tempClass = 'temp-cold';
        } else if (percentageOff >= 0.15) {
          underMessage = 'WARM';
          tempClass = 'temp-warm';
        } else if (percentageOff >= 0.05) {
          underMessage = 'VERY WARM';
          tempClass = 'temp-very-warm';
        } else {
          underMessage = 'RED HOT';
          tempClass = 'temp-red-hot';
        }
        
        document.getElementById('feedback').innerHTML = `You guessed $${guess}. You are <span class="${tempClass}">${underMessage}</span>. Try again!`;
        document.getElementById('guessesRemaining').textContent = `Guesses remaining: ${remaining}`;
      } else {
        document.getElementById('guessesRemaining').textContent = '';
        endRound(true, actualPrice);
      }
      input.value = '';
    }

    function endRound(finalRound, actualPrice) {
      gameOver = true;
      const lastGuess = guesses[guesses.length - 1];
      
      // Always calculate score based on accuracy (no more bust)
      let roundScore = calculateScore(lastGuess, actualPrice);
      
      // Double points for showcase round (round 4)
      if (currentRound === 4) {
        roundScore = roundScore * 2;
      }
      
      let resultText = `<strong>Actual retail price: $${actualPrice}.</strong><br>`;
      
      const diff = Math.abs(actualPrice - lastGuess);
      if (diff === 0) {
        resultText += `Wow! You were right on the money with that one! 🎉`;
      } else {
        const percentageOff = (diff / actualPrice * 100).toFixed(1);
        const overOrUnder = lastGuess > actualPrice ? 'over' : 'under';
        resultText += `You were ${percentageOff}% ${overOrUnder}.`;
      }
      
      // Add showcase bonus indicator
      if (currentRound === 4) {
        resultText += `<br><br>🎯 SHOWCASE DOUBLE POINTS! 🎯`;
      }
      
      // Add colored score
      const scoreClass = getScoreColorClass(roundScore);
      resultText += `<br><span class="score-text ${scoreClass}">Round Score: ${roundScore.toLocaleString()} points</span>`;
      
      // Show formatted result
      showResultMessage(resultText);

      roundScores.push(roundScore);
      totalScore += roundScore;
      
      // Add round to history
      let details = '';
      if (diff === 0) {
        details = 'Perfect guess!';
      } else {
        const percentageOff = (diff / actualPrice * 100).toFixed(1);
        const overOrUnder = lastGuess > actualPrice ? 'over' : 'under';
        details = `${percentageOff}% ${overOrUnder}`;
      }
      
      roundHistory.push({
        score: roundScore,
        scoreClass: getScoreColorClass(roundScore),
        details: details
      });
      
      // Update sidebar displays
      updateSidebar();
      showCurrentRoundScore(roundScore, details, getScoreColorClass(roundScore));
      
      updateRoundDisplay();
    }

    // Image modal functions
    function openImageModal(imageSrc) {
      document.getElementById('modalImage').src = imageSrc;
      document.getElementById('imageModal').style.display = 'block';
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    // Close modal when clicking outside the image
    document.getElementById('imageModal').onclick = function(event) {
      if (event.target === this) {
        closeImageModal();
      }
    };

    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeImageModal();
      }
    });

    async function showFinalResults() {
      let grade = 'F';
      if (totalScore >= 4500) grade = 'A+';  // 90%+
      else if (totalScore >= 4000) grade = 'A';   // 80%+
      else if (totalScore >= 3500) grade = 'B+';  // 70%+
      else if (totalScore >= 3000) grade = 'B';   // 60%+
      else if (totalScore >= 2500) grade = 'C+';  // 50%+
      else if (totalScore >= 2000) grade = 'C';   // 40%+
      else if (totalScore >= 1500) grade = 'D';   // 30%+
      
      // Submit score and get daily average
      const dailyStats = await submitScoreToDatabase(totalScore);
      
      // Debug: Log the daily stats to see what we're getting
      console.log('Daily stats received:', dailyStats);
      if (dailyStats && dailyStats.historicalData) {
        console.log('Historical data length:', dailyStats.historicalData.length);
        console.log('Historical data:', dailyStats.historicalData);
      }
      
      let dailyAverageText = '';
      if (dailyStats) {
        dailyAverageText = `
          <p style="font-size: 1.1rem; color: #6c757d; margin: 1rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 5px;">
            📊 Today's Average: <strong>${dailyStats.average.toLocaleString()}</strong> points
          </p>
        `;
      }

      // Create chart if historical data is available
      let chartHTML = '';
      if (dailyStats && dailyStats.historicalData && dailyStats.historicalData.length >= 1) {
        console.log('Creating chart with data:', dailyStats.historicalData);
        chartHTML = `
          <div style="margin: 1.5rem 0;">
            <h4 style="color: #495057; margin-bottom: 1rem;">📈 Score Trend (Last ${dailyStats.historicalData.length} Days)</h4>
            <div style="position: relative; height: 250px; background: #f8f9fa; border-radius: 8px; padding: 10px;">
              <canvas id="scoreChart" style="max-height: 230px;"></canvas>
            </div>
          </div>
        `;
      } else {
        console.log('Not enough historical data for chart. Need at least 1 day, got:', dailyStats?.historicalData?.length || 0);
      }

      const completionContent = `
        <div style="text-align: center;">
          <h3 style="color: #28a745; font-size: 1.8rem; margin-top: 0;">🎉 Game Complete!</h3>
          <p style="font-size: 1.3rem; color: #495057; margin: 1rem 0;"><strong>Final Score: ${totalScore.toLocaleString()} / 5,000 points</strong></p>
          <p style="font-size: 1.5rem; color: #007acc; margin: 1rem 0; font-weight: bold;">Grade: ${grade}</p>
          ${dailyAverageText}
          ${chartHTML}
          <p style="color: #6c757d; font-style: italic; margin-top: 1.5rem;">Come back tomorrow for a new challenge!</p>
        </div>
      `;
      
      // Create modal backdrop
      const backdrop = document.createElement('div');
      backdrop.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
        align-items: center; z-index: 1000;
      `;
      
      // Create modal content
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white; padding: 2rem; border-radius: 12px; 
        max-width: 600px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        font-family: Arial, sans-serif; line-height: 1.6; border: 3px solid #28a745;
        max-height: 90vh; overflow-y: auto;
      `;
      
      modal.innerHTML = completionContent;
      
      // Add close button
      const closeButton = document.createElement('button');
      closeButton.textContent = 'Close';
      closeButton.style.cssText = `
        background: #28a745; color: white; border: none; padding: 0.8rem 1.5rem; 
        border-radius: 8px; cursor: pointer; font-size: 1rem; margin-top: 1rem;
      `;
      closeButton.onclick = () => {
        document.body.removeChild(backdrop);
        showGameOverState(); // Replace game content with thank you message
      };
      
      modal.appendChild(closeButton);
      backdrop.appendChild(modal);
      document.body.appendChild(backdrop);
      
      // Hide the input box and submit button to indicate game is over
      const inputBox = document.getElementById('guessInput');
      const submitButton = document.getElementById('guessButton');
      const showcaseInput = document.getElementById('guessInputShowcase');
      const showcaseButton = document.getElementById('guessButtonShowcase');
      
      if (inputBox) inputBox.style.display = 'none';
      if (submitButton) submitButton.style.display = 'none';
      if (showcaseInput) showcaseInput.style.display = 'none';
      if (showcaseButton) showcaseButton.style.display = 'none';
      
      // Create the chart after the modal is in the DOM
      if (dailyStats && dailyStats.historicalData && dailyStats.historicalData.length >= 1) {
        console.log('Attempting to create chart...');
        // Wait for the next frame to ensure canvas is rendered
        requestAnimationFrame(() => {
          const canvas = document.getElementById('scoreChart');
          if (canvas) {
            console.log('Canvas found, creating chart');
            createScoreChart(dailyStats.historicalData, totalScore);
          } else {
            console.error('Canvas not found!');
          }
        });
      } else {
        console.log('Skipping chart creation - insufficient data');
      }
    }

    // Show game over state after final results
    function showGameOverState() {
      const gameContainer = document.querySelector('.game-container');
      if (gameContainer) {
        gameContainer.innerHTML = `
          <div style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            z-index: 100;
          ">
            <h2 style="color: #28a745; font-size: 3rem; margin-bottom: 1rem; font-family: 'Gabarito', sans-serif;">🎉</h2>
            <h3 style="color: #333; font-size: 2.5rem; margin-bottom: 1rem; font-family: 'Gabarito', sans-serif;">Thanks for Playing!</h3>
            <p style="color: #6c757d; font-size: 1.5rem; margin-bottom: 2rem; font-family: Arial, sans-serif;">Come Back Tomorrow!</p>
            <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 1rem 2rem; border-radius: 15px; font-size: 1.2rem; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
              New game available daily at midnight! 🌟
            </div>
          </div>
        `;
      }
    }
    
    // Preview Mode Functions
    let previewMode = false;
    let originalState = {};
    
    function togglePreviewMode() {
      if (!previewMode) {
        // Check if gameData is loaded
        if (!gameData || !gameData.single_items || !gameData.showcases) {
          alert('Game data not loaded yet. Please wait a moment and try again.');
          return;
        }
        
        previewMode = true;
        
        // Save current game state
        originalState = {
          currentRound: currentRound,
          gameData: gameData,
          currentItem: currentItem,
          currentShowcase: currentShowcase
        };
        
        // Show preview navigation
        document.getElementById('previewRoundNav').style.display = 'flex';
        document.getElementById('togglePreviewMode').textContent = '❌ Exit Preview Mode';
        
        // Start with round 1
        previewRound(1);
      } else {
        exitPreviewMode();
      }
    }
    
    function previewRound(roundNum) {
      if (!previewMode) return;
      
      console.log('Previewing round:', roundNum); // Debug
      
      // Hide current views
      document.getElementById('singleItemView').classList.add('hidden');
      document.getElementById('showcaseView').classList.add('hidden');
      if (document.getElementById('gameCompleteView')) {
        document.getElementById('gameCompleteView').classList.add('hidden');
      }
      
      // Update round display
      if (typeof updateProgressLine === 'function') {
        updateProgressLine(roundNum);
      }
      currentRound = roundNum;
      
      if (roundNum <= 3) {
        // Show single item for rounds 1-3
        const item = gameData.single_items[roundNum - 1];
        console.log('Preview item:', item); // Debug
        
        if (item) {
          currentItem = item;
          
          // Update single item display
          document.getElementById('itemImage').src = item.image;
          
          // Handle both old format (title only) and new format (brand + title)
          const hasBrand = item.brand && item.brand.trim() !== '';
          const hasTitle = item.title && item.title.trim() !== '';
          
          if (hasBrand && hasTitle) {
            document.getElementById('itemBrand').textContent = item.brand.trim();
            document.getElementById('itemTitle').textContent = item.title.trim();
          } else if (hasTitle) {
            const fullTitle = item.title.trim();
            const parts = fullTitle.split(' ');
            if (parts.length >= 2) {
              document.getElementById('itemBrand').textContent = parts[0];
              document.getElementById('itemTitle').textContent = parts.slice(1).join(' ');
            } else {
              document.getElementById('itemBrand').textContent = fullTitle;
              document.getElementById('itemTitle').textContent = '';
            }
          }
          
          // Update store info
          if (item.store && gameData.stores && gameData.stores[item.store]) {
            const storeInfo = gameData.stores[item.store];
            document.getElementById('itemStoreLogo').src = storeInfo.logo;
            document.getElementById('itemStoreName').textContent = storeInfo.name;
          }
          
          // Update description
          document.getElementById('itemDescription').textContent = item.description || '';
          
          document.getElementById('singleItemView').classList.remove('hidden');
          
          // Hide guess controls in preview
          const guessContainer = document.querySelector('#singleItemView .guess-input-container');
          if (guessContainer) guessContainer.style.display = 'none';
        }
      } else if (roundNum === 4) {
        // Show showcase
        const showcase = gameData.showcases[0];
        console.log('Preview showcase:', showcase); // Debug
        
        if (showcase) {
          currentShowcase = showcase;
          currentGalleryIndex = 0; // Start with first item
          
          // Set the showcase title
          document.getElementById('showcaseTitle').textContent = showcase.title || 'Showcase Showdown';
          
          // Update showcase display
          updateGalleryDisplay();
          
          document.getElementById('showcaseView').classList.remove('hidden');
          
          // Hide guess controls in preview
          const guessContainer = document.querySelector('#showcaseView .guess-input-container');
          if (guessContainer) guessContainer.style.display = 'none';
        }
      }
      
      // Add preview indicator
      const indicator = document.createElement('div');
      indicator.id = 'previewIndicator';
      indicator.style.cssText = `
        position: fixed; top: 10px; right: 10px; background: #ff6b35; color: white; 
        padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      `;
      indicator.textContent = `🔍 PREVIEW: Round ${roundNum}`;
      
      // Remove existing indicator
      const existingIndicator = document.getElementById('previewIndicator');
      if (existingIndicator) existingIndicator.remove();
      
      document.body.appendChild(indicator);
    }
    
    function exitPreviewMode() {
      previewMode = false;
      
      // Hide preview navigation
      document.getElementById('previewRoundNav').style.display = 'none';
      document.getElementById('togglePreviewMode').textContent = '🔍 Quick Preview All Rounds';
      
      // Show guess controls again
      const guessContainers = document.querySelectorAll('.guess-input-container');
      guessContainers.forEach(container => container.style.display = '');
      
      // Remove preview indicator
      const indicator = document.getElementById('previewIndicator');
      if (indicator) indicator.remove();
      
      // Hide all views first
      document.getElementById('singleItemView').classList.add('hidden');
      document.getElementById('showcaseView').classList.add('hidden');
      if (document.getElementById('gameCompleteView')) {
        document.getElementById('gameCompleteView').classList.add('hidden');
      }
      
      // Restore original state and restart current round
      if (originalState.currentRound) {
        currentRound = originalState.currentRound;
        currentItem = originalState.currentItem;
        currentShowcase = originalState.currentShowcase;
        
        // Restart the current round properly
        if (typeof startRound === 'function') {
          startRound();
        } else {
          // Fallback - just reload the game
          if (typeof loadGameData === 'function') {
            loadGameData();
          }
        }
      } else {
        // If no original state, just reload
        if (typeof loadGameData === 'function') {
          loadGameData();
        }
      }
    }
  </script>

</body>
</html>
